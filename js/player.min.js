document.addEventListener("DOMContentLoaded",()=>{let e=document.querySelectorAll(".audio-player"),t="img/sprite.svg",r=`${t}#play`,s=`${t}#pause`,a=`${t}#volume`,i=`${t}#volume-off`;function n(e){let t=e.querySelector(".audio-element"),n=e.querySelector(".play-pause-btn"),c=e.querySelector(".progress-bar"),d=e.querySelector(".current-time"),p=e.querySelector(".duration"),v=e.querySelector(".volume-container"),y=e.querySelector(".volume-btn"),b=e.querySelector(".volume-slider"),m=e.querySelector(".options-btn"),f=e.querySelector(".options-menu"),L=e.querySelector(".speed-menu-item"),S=e.querySelector(".speed-submenu"),$=e.querySelector(".speed-list"),q=e.querySelector(".back-btn"),g=e.querySelector(".download-link"),h=!1,E=null;function A(e){e=isNaN(e)?0:e;let t=Math.floor(e/60),r=Math.floor(e%60);return`${t}:${r<10?"0":""}${r}`}function x(){let e=0;t.duration&&(e=t.currentTime/t.duration*100),c.style.setProperty("--progress-percentage",`${e}%`),h||(c.value=e),d.textContent=A(t.currentTime)}function w(){let e=n.querySelector("use");e&&(e.setAttribute("href",t.paused?r:s),n.setAttribute("aria-label",t.paused?"Воспроизвести":"Пауза"))}function k(){let e=y.querySelector("use");if(!e)return;let r=t.muted||0===t.volume;e.setAttribute("href",r?i:a),y.setAttribute("aria-label",r?"Включить звук":"Выключить звук")}function _(e){let t=$.querySelectorAll("li");t.forEach(t=>{let r=parseFloat(t.dataset.speed),s=r===e;t.setAttribute("aria-checked",s);let a=t.querySelector("svg use");a&&a.closest("svg")&&(a.closest("svg").style.visibility=s?"visible":"hidden")}),L.setAttribute("aria-expanded","false")}if(n.addEventListener("click",()=>{(t.src||t.currentSrc)&&(t.paused?(l(e),t.play()):t.pause(),w())}),t.addEventListener("loadedmetadata",()=>{if(p.textContent=A(t.duration),c.value=0,c.style.setProperty("--progress-percentage","0%"),t.currentSrc){g.href=t.currentSrc;try{let e=new URL(t.currentSrc),r=e.pathname.split("/").pop();r&&g.setAttribute("download",r)}catch(s){}}else g.style.display="none"}),t.addEventListener("canplay",()=>{t.duration&&(p.textContent=A(t.duration))}),t.addEventListener("timeupdate",x),t.addEventListener("ended",()=>{t.currentTime=0,w(),x()}),c.addEventListener("mousedown",()=>{t.duration&&(h=!0)}),c.addEventListener("touchstart",()=>{t.duration&&(h=!0)},{passive:!0}),c.addEventListener("input",()=>{if(!t.duration)return;let e=c.value;c.style.setProperty("--progress-percentage",`${e}%`);let r=t.duration/100*e;d.textContent=A(r),!h&&t.duration&&(h=!0)}),c.addEventListener("change",()=>{if(!t.duration)return;let e=t.duration/100*c.value;t.currentTime=e,h&&(h=!1),x()}),c.addEventListener("mouseup",()=>{h&&c.dispatchEvent(new Event("change"))}),c.addEventListener("touchend",()=>{h&&c.dispatchEvent(new Event("change"))}),y.addEventListener("click",r=>{r.stopPropagation(),E||(v.classList.contains("active")?function r(s=300){if(E&&clearInterval(E),0===t.volume){t.muted=!0,k();return}let a=t.volume;e.dataset.lastVolume=a;let i=Date.now();E=setInterval(()=>{let e=Date.now()-i,r=e/s;r>=1?(t.volume=0,t.muted=!0,b.value=0,clearInterval(E),E=null,k()):(t.volume=a*(1-r),b.value=t.volume,k())},15)}(300):(u(e),v.classList.add("active")))}),b.addEventListener("input",()=>{E&&clearInterval(E);let e=parseFloat(b.value);t.volume=e,e>0?t.muted=!1:t.muted=!0,k()}),m.addEventListener("click",t=>{t.stopPropagation(),o(e);let r=f.classList.toggle("visible");m.setAttribute("aria-expanded",r),r&&(S.classList.remove("visible"),L.setAttribute("aria-expanded","false"))}),L.addEventListener("click",e=>{e.stopPropagation(),f.classList.remove("visible"),S.classList.add("visible"),L.setAttribute("aria-expanded","true"),m.setAttribute("aria-expanded","true")}),q.addEventListener("click",e=>{e.stopPropagation(),S.classList.remove("visible"),f.classList.add("visible"),L.setAttribute("aria-expanded","false"),m.setAttribute("aria-expanded","true")}),$.addEventListener("click",e=>{e.stopPropagation();let r=e.target.closest("li");if(r&&r.dataset.speed){let s=parseFloat(r.dataset.speed);t.playbackRate=s,_(s),S.classList.remove("visible"),f.classList.add("visible"),L.setAttribute("aria-expanded","false"),m.setAttribute("aria-expanded","true")}}),k(),w(),_(t.playbackRate||1),b.value=t.volume,c.value=0,c.style.setProperty("--progress-percentage","0%"),d.textContent="0:00",p.textContent=A(t.duration),m.setAttribute("aria-expanded","false"),f.classList.remove("visible"),S.classList.remove("visible"),t.currentSrc){g.href=t.currentSrc;try{let P=new URL(t.currentSrc),C=P.pathname.split("/").pop();C&&g.setAttribute("download",C)}catch(T){}}else if(t.src){g.href=t.src;try{let R=new URL(t.src),D=R.pathname.split("/").pop();D&&g.setAttribute("download",D)}catch(M){}}else g.style.display="none";t.src||t.currentSrc||(console.warn("Аудиофайл не найден:",e),e.style.opacity="0.5")}function l(t){e.forEach(e=>{if(e!==t){let s=e.querySelector(".audio-element"),a=e.querySelector(".play-pause-btn");if(s&&!s.paused){s.pause();let i=a?a.querySelector("use"):null;i&&i.setAttribute("href",r),a&&a.setAttribute("aria-label","Воспроизвести")}}})}function o(t=null){e.forEach(e=>{if(e!==t){let r=e.querySelector(".options-menu"),s=e.querySelector(".speed-submenu"),a=e.querySelector(".options-btn"),i=e.querySelector(".speed-menu-item"),n=e.querySelector(".volume-container");r&&r.classList.contains("visible")&&(r.classList.remove("visible"),a&&a.setAttribute("aria-expanded","false")),s&&s.classList.contains("visible")&&(s.classList.remove("visible"),i&&i.setAttribute("aria-expanded","false"),a&&a.setAttribute("aria-expanded","false")),n&&n.classList.contains("active")&&n.classList.remove("active")}})}function u(t){e.forEach(e=>{if(e!==t){let r=e.querySelector(".volume-container");r&&r.classList.contains("active")&&r.classList.remove("active")}})}document.addEventListener("click",t=>{let r=!1;e.forEach(e=>{let s=e.querySelector(".options-menu"),a=e.querySelector(".speed-submenu"),i=e.querySelector(".options-btn"),n=e.querySelector(".volume-container"),l=e.querySelector(".volume-btn");(i&&i.contains(t.target)||s&&s.classList.contains("visible")&&s.contains(t.target)||a&&a.classList.contains("visible")&&a.contains(t.target)||n&&n.classList.contains("active")&&n.contains(t.target)||l&&l.contains(t.target))&&(r=!0)}),r||o()}),e.forEach(e=>{n(e)})});